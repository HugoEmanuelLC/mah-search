<%- include('partials/header'); -%>

<section>
  <h2>List de jobs :</h2>
<% if (user) { %>
  <div class="bloc_filters">
    <h2 class="titre">Filter by:</h2>
    <div class="filters">
      <form>
        <div class="filter">
          <div><label for="filterStatus">Status</label></div>
          <select name="filterStatus" id="filterStatus" required>
            <option value="0"></option>
            <option value="interested">Interested</option>
            <option value="sent">CV sent</option>
            <option value="negative">Negative</option>
            <option value="interview">Interview</option>
          </select>
        </div>
        <div class="filter">
          <div><label for="filterOrigin">Origin</label></div>
          <select name="filterOrigin" id="filterOrigin" required>
            <option value="0"></option>
            <option value="spontaneous">spontaneous application</option>
            <option value="offer">Job offer</option>
          </select>
        </div>

        <button>filtrer</button>
      </form>
    </div>
  </div>
  <div class="bloc_jobs">
    <ul class="jobs"></ul>
  </div>

<% } %>
</section>

<%- include('partials/footer'); -%>


<script>
const jobsList = document.querySelector('.jobs');
const filterStatus = document.querySelector('#filterStatus');
const filterOrigin = document.querySelector('#filterOrigin');
document.querySelector('form')
.addEventListener('submit', (e) => {
  e.preventDefault();
  console.log(filterStatus.value);
  console.log(filterOrigin.value);
  fetchData();
})

  async function fetchData(filterStatus, filterOrigin) {
    try {
      const response = await fetch('/list-jobs');
      const data = await response.json();
      console.log(data);
      data.forEach(job => {
        if (job.origin[0] == filterOrigin && job.statusJob[0] == filterStatus) {
          jobsList.innerHTML = '';
          const listItem = document.createElement('li');
          listItem.classList.add('recipe');

          const date = document.createElement('p');
            const dateObj = new Date(job.date);
            const day = dateObj.getDate();
            const month = dateObj.getMonth() + 1;
            const year = dateObj.getFullYear();
            date.textContent = `${day}/${month}/${year}`;

          const title = document.createElement('h4');
          title.textContent = job.jobTitle;

          const company = document.createElement('p');
          company.textContent = job.company;

          const origin = document.createElement('p');
          origin.textContent = job.origin;

          const status = document.createElement('p');
          status.textContent = job.statusJob;

          const comment = document.createElement('p');
          comment.textContent = job.comment;

          const del = document.createElement('button');
          del.classList.add('delete');
          del.textContent = "Delete";
          del.setAttribute('data-id', job._id);

          const details = document.createElement('button');
          details.classList.add('details');
          details.textContent = "Details";
          details.setAttribute('data-id', job._id);

          listItem.append(date, title, company, origin, status, comment, del, details);
          jobsList.appendChild(listItem);
        } else if (job.origin[0] == filterOrigin && filterStatus == "") {
          jobsList.innerHTML = '';
          const listItem = document.createElement('li');
          listItem.classList.add('recipe');

          const date = document.createElement('p');
            const dateObj = new Date(job.date);
            const day = dateObj.getDate();
            const month = dateObj.getMonth() + 1;
            const year = dateObj.getFullYear();
            date.textContent = `${day}/${month}/${year}`;

          const title = document.createElement('h4');
          title.textContent = job.jobTitle;

          const company = document.createElement('p');
          company.textContent = job.company;

          const origin = document.createElement('p');
          origin.textContent = job.origin;

          const status = document.createElement('p');
          status.textContent = job.statusJob;

          const comment = document.createElement('p');
          comment.textContent = job.comment;

          const del = document.createElement('button');
          del.classList.add('delete');
          del.textContent = "Delete";
          del.setAttribute('data-id', job._id);

          const details = document.createElement('button');
          details.classList.add('details');
          details.textContent = "Details";
          details.setAttribute('data-id', job._id);

          listItem.append(date, title, company, origin, status, comment, del, details);
          jobsList.appendChild(listItem);
          
        } else if(job.statusJob[0] == "0" && filterOrigin == "0") {
          jobsList.innerHTML = '';
          const listItem = document.createElement('li');
          listItem.classList.add('recipe');

          const date = document.createElement('p');
            const dateObj = new Date(job.date);
            const day = dateObj.getDate();
            const month = dateObj.getMonth() + 1;
            const year = dateObj.getFullYear();
            date.textContent = `${day}/${month}/${year}`;

          const title = document.createElement('h4');
          title.textContent = job.jobTitle;

          const company = document.createElement('p');
          company.textContent = job.company;

          const origin = document.createElement('p');
          origin.textContent = job.origin;

          const status = document.createElement('p');
          status.textContent = job.statusJob;

          const comment = document.createElement('p');
          comment.textContent = job.comment;

          const del = document.createElement('button');
          del.classList.add('delete');
          del.textContent = "Delete";
          del.setAttribute('data-id', job._id);

          const details = document.createElement('button');
          details.classList.add('details');
          details.textContent = "Details";
          details.setAttribute('data-id', job._id);

          listItem.append(date, title, company, origin, status, comment, del, details);
          jobsList.appendChild(listItem);
        }
      });
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }
  fetchData("", "");

    // delete | detail => profile
    document.addEventListener('click', async (e) => {

        if (e.target.matches('.delete')) {
          try {
            const res = await fetch('/job', {
                method: 'DELETE',
                body: JSON.stringify({_id: e.target.dataset.id}),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            console.log(data);
            location.assign('/');
          }
          catch (err) {
              console.log(err);
          }
        }else if(e.target.matches('.details')){
          // CREER UN FORMULAIRE POUR MODIFIER LE JOB:
          console.log(e.target.dataset.id);
          try {
            jobsList.innerHTML = '';
            const res = await fetch('/detail-job', {
                method: 'POST',
                body: JSON.stringify({_id: e.target.dataset.id}),
                headers: { 'Content-Type': 'application/json' }
            })
            const data = await res.json();
            console.log(data.job);

            const listItem = document.createElement('li');
              listItem.classList.add('recipe');

              const date = document.createElement('p');
                const dateObj = new Date(data.job.date);
                const day = dateObj.getDate();
                const month = dateObj.getMonth() + 1;
                const year = dateObj.getFullYear();
                date.textContent = `${day}/${month}/${year}`;

              const title = document.createElement('h4');
              title.textContent = data.job.jobTitle;

              const company = document.createElement('p');
              company.textContent = data.job.company;

              const origin = document.createElement('p');
              origin.textContent = data.job.origin;

              const status = document.createElement('p');
              status.textContent = data.job.statusJob;

              const comment = document.createElement('p');
              comment.textContent = data.job.comment;

              const del = document.createElement('button');
              del.classList.add('delete');
              del.textContent = "Delete";
              del.setAttribute('data-id', data.job._id);

              const details = document.createElement('button');
              details.classList.add('details');
              details.textContent = "Details";
              details.setAttribute('data-id', data.job._id);

              listItem.append(date, title, company, origin, status, comment, del, details);
              jobsList.appendChild(listItem);
          }
          catch (err) {
              console.log(err);
          }
        }
    });
</script>